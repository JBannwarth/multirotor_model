clear;
mpc_self.mpc_FLT_EPSILON = 0;
mpc_self.mpc_MANUAL_THROTTLE_MAX_MULTICOPTER = 0;
mpc_self.mpc_MIN_DIST = 0;
mpc_self.mpc_ONE_G = 0;
mpc_self.mpc_R = zeros(3,3);
mpc_self.mpc_R_setpoint = zeros(3,3);
mpc_self.mpc_SIGMA = 0;
mpc_self.mpc_TILT_COS_MAX = 0;
mpc_self.mpc_acc_z_lp = 0;
mpc_self.mpc_alt_hold_engaged = 0;
mpc_self.mpc_arming.armed = 0;
mpc_self.mpc_arming_sub = 0;
mpc_self.mpc_att_sp.disable_mc_yaw_control = 0;
mpc_self.mpc_att_sp.landing_gear = 0;
mpc_self.mpc_att_sp.pitch_body = 0;
mpc_self.mpc_att_sp.q_d = zeros(4,1);
mpc_self.mpc_att_sp.q_d_valid = 0;
mpc_self.mpc_att_sp.roll_body = 0;
mpc_self.mpc_att_sp.thrust = 0;
mpc_self.mpc_att_sp.timestamp = 0;
mpc_self.mpc_att_sp.yaw_body = 0;
mpc_self.mpc_att_sp.yaw_sp_move_rate = 0;
mpc_self.mpc_att_sp_sub = 0;
mpc_self.mpc_control_mode.flag_armed = 0;
mpc_self.mpc_control_mode.flag_control_acceleration_enabled = 0;
mpc_self.mpc_control_mode.flag_control_altitude_enabled = 0;
mpc_self.mpc_control_mode.flag_control_attitude_enabled = 0;
mpc_self.mpc_control_mode.flag_control_climb_rate_enabled = 0;
mpc_self.mpc_control_mode.flag_control_manual_enabled = 0;
mpc_self.mpc_control_mode.flag_control_offboard_enabled = 0;
mpc_self.mpc_control_mode.flag_control_position_enabled = 0;
mpc_self.mpc_control_mode.flag_control_velocity_enabled = 0;
mpc_self.mpc_control_mode_sub = 0;
mpc_self.mpc_control_vel_enabled_prev = 0;
mpc_self.mpc_ctrl_state.delta_q_reset = zeros(4,1);
mpc_self.mpc_ctrl_state.q = zeros(4,1);
mpc_self.mpc_ctrl_state.quat_reset_counter = 0;
mpc_self.mpc_ctrl_state_sub = 0;
mpc_self.mpc_do_reset_alt_pos_flag = 0;
mpc_self.mpc_global_vel_sp.vx = 0;
mpc_self.mpc_global_vel_sp.vy = 0;
mpc_self.mpc_global_vel_sp.vz = 0;
mpc_self.mpc_heading_reset_counter = 0;
mpc_self.mpc_hold_offboard_xy = 0;
mpc_self.mpc_hold_offboard_z = 0;
mpc_self.mpc_hrt_absolute_time = 0;
mpc_self.mpc_in_landing = 0;
mpc_self.mpc_initialized = 0;
mpc_self.mpc_lnd_reached_ground = 0;
mpc_self.mpc_local_pos.delta_vxy = zeros(2,1);
mpc_self.mpc_local_pos.delta_vz = 0;
mpc_self.mpc_local_pos.delta_xy = zeros(2,1);
mpc_self.mpc_local_pos.delta_z = 0;
mpc_self.mpc_local_pos.dist_bottom = 0;
mpc_self.mpc_local_pos.dist_bottom_rate = 0;
mpc_self.mpc_local_pos.dist_bottom_valid = 0;
mpc_self.mpc_local_pos.ref_alt = 0;
mpc_self.mpc_local_pos.ref_lat = 0;
mpc_self.mpc_local_pos.ref_lon = 0;
mpc_self.mpc_local_pos.ref_timestamp = 0;
mpc_self.mpc_local_pos.timestamp = 0;
mpc_self.mpc_local_pos.vx = 0;
mpc_self.mpc_local_pos.vxy_reset_counter = 0;
mpc_self.mpc_local_pos.vy = 0;
mpc_self.mpc_local_pos.vz = 0;
mpc_self.mpc_local_pos.vz_reset_counter = 0;
mpc_self.mpc_local_pos.x = 0;
mpc_self.mpc_local_pos.xy_reset_counter = 0;
mpc_self.mpc_local_pos.xy_valid = 0;
mpc_self.mpc_local_pos.y = 0;
mpc_self.mpc_local_pos.z = 0;
mpc_self.mpc_local_pos.z_reset_counter = 0;
mpc_self.mpc_local_pos.z_valid = 0;
mpc_self.mpc_local_pos_sp.acc_x = 0;
mpc_self.mpc_local_pos_sp.acc_y = 0;
mpc_self.mpc_local_pos_sp.acc_z = 0;
mpc_self.mpc_local_pos_sp.timestamp = 0;
mpc_self.mpc_local_pos_sp.vx = 0;
mpc_self.mpc_local_pos_sp.vy = 0;
mpc_self.mpc_local_pos_sp.vz = 0;
mpc_self.mpc_local_pos_sp.x = 0;
mpc_self.mpc_local_pos_sp.y = 0;
mpc_self.mpc_local_pos_sp.yaw = 0;
mpc_self.mpc_local_pos_sp.z = 0;
mpc_self.mpc_local_pos_sub = 0;
mpc_self.mpc_manual.gear_switch = 0;
mpc_self.mpc_manual.r = 0;
mpc_self.mpc_manual.x = 0;
mpc_self.mpc_manual.y = 0;
mpc_self.mpc_manual.z = 0;
mpc_self.mpc_manual_control_setpoint_s.SWITCH_POS_OFF = 0;
mpc_self.mpc_manual_control_setpoint_s.SWITCH_POS_ON = 0;
mpc_self.mpc_manual_sub = 0;
mpc_self.mpc_manual_thr_max = 0;
mpc_self.mpc_manual_thr_min = 0;
mpc_self.mpc_mode_auto = 0;
mpc_self.mpc_param_find.MC_YAWRATE_MAX = 0;
mpc_self.mpc_param_find.MC_YAW_P = 0;
mpc_self.mpc_param_find.MPC_ACC_HOR_MAX = 0;
mpc_self.mpc_param_find.MPC_ALTCTL_DY = 0;
mpc_self.mpc_param_find.MPC_ALTCTL_DZ = 0;
mpc_self.mpc_param_find.MPC_ALT_MODE = 0;
mpc_self.mpc_param_find.MPC_HOLD_MAX_XY = 0;
mpc_self.mpc_param_find.MPC_HOLD_MAX_Z = 0;
mpc_self.mpc_param_find.MPC_HOLD_XY_DZ = 0;
mpc_self.mpc_param_find.MPC_LAND_SPEED = 0;
mpc_self.mpc_param_find.MPC_MAN_P_MAX = 0;
mpc_self.mpc_param_find.MPC_MAN_R_MAX = 0;
mpc_self.mpc_param_find.MPC_MAN_Y_MAX = 0;
mpc_self.mpc_param_find.MPC_THR_HOVER = 0;
mpc_self.mpc_param_find.MPC_THR_MAX = 0;
mpc_self.mpc_param_find.MPC_THR_MIN = 0;
mpc_self.mpc_param_find.MPC_TILTMAX_AIR = 0;
mpc_self.mpc_param_find.MPC_TILTMAX_LND = 0;
mpc_self.mpc_param_find.MPC_TKO_SPEED = 0;
mpc_self.mpc_param_find.MPC_VELD_LP = 0;
mpc_self.mpc_param_find.MPC_XY_CRUISE = 0;
mpc_self.mpc_param_find.MPC_XY_FF = 0;
mpc_self.mpc_param_find.MPC_XY_P = 0;
mpc_self.mpc_param_find.MPC_XY_VEL_D = 0;
mpc_self.mpc_param_find.MPC_XY_VEL_I = 0;
mpc_self.mpc_param_find.MPC_XY_VEL_MAX = 0;
mpc_self.mpc_param_find.MPC_XY_VEL_P = 0;
mpc_self.mpc_param_find.MPC_Z_FF = 0;
mpc_self.mpc_param_find.MPC_Z_P = 0;
mpc_self.mpc_param_find.MPC_Z_VEL_D = 0;
mpc_self.mpc_param_find.MPC_Z_VEL_I = 0;
mpc_self.mpc_param_find.MPC_Z_VEL_MAX = 0;
mpc_self.mpc_param_find.MPC_Z_VEL_MAX_DN = 0;
mpc_self.mpc_param_find.MPC_Z_VEL_MAX_UP = 0;
mpc_self.mpc_param_find.MPC_Z_VEL_P = 0;
mpc_self.mpc_param_find.VT_OPT_RECOV_EN = 0;
mpc_self.mpc_params.acc_hor_max = 0;
mpc_self.mpc_params.alt_ctl_dy = 0;
mpc_self.mpc_params.alt_ctl_dz = 0;
mpc_self.mpc_params.alt_mode = 0;
mpc_self.mpc_params.global_yaw_max = 0;
mpc_self.mpc_params.hold_max_xy = 0;
mpc_self.mpc_params.hold_max_z = 0;
mpc_self.mpc_params.hold_xy_dz = 0;
mpc_self.mpc_params.land_speed = 0;
mpc_self.mpc_params.man_pitch_max = 0;
mpc_self.mpc_params.man_roll_max = 0;
mpc_self.mpc_params.man_yaw_max = 0;
mpc_self.mpc_params.mc_att_yaw_p = 0;
mpc_self.mpc_params.opt_recover = 0;
mpc_self.mpc_params.pos_p = zeros(3,1);
mpc_self.mpc_params.sp_offs_max = zeros(3,1);
mpc_self.mpc_params.thr_hover = 0;
mpc_self.mpc_params.thr_max = 0;
mpc_self.mpc_params.thr_min = 0;
mpc_self.mpc_params.tilt_max_air = 0;
mpc_self.mpc_params.tilt_max_land = 0;
mpc_self.mpc_params.tko_speed = 0;
mpc_self.mpc_params.vel_cruise = zeros(3,1);
mpc_self.mpc_params.vel_d = zeros(3,1);
mpc_self.mpc_params.vel_ff = zeros(3,1);
mpc_self.mpc_params.vel_i = zeros(3,1);
mpc_self.mpc_params.vel_max = zeros(3,1);
mpc_self.mpc_params.vel_max_down = 0;
mpc_self.mpc_params.vel_max_up = 0;
mpc_self.mpc_params.vel_p = zeros(3,1);
mpc_self.mpc_params_handles.acc_hor_max = 0;
mpc_self.mpc_params_handles.alt_ctl_dy = 0;
mpc_self.mpc_params_handles.alt_ctl_dz = 0;
mpc_self.mpc_params_handles.alt_mode = 0;
mpc_self.mpc_params_handles.global_yaw_max = 0;
mpc_self.mpc_params_handles.hold_max_xy = 0;
mpc_self.mpc_params_handles.hold_max_z = 0;
mpc_self.mpc_params_handles.hold_xy_dz = 0;
mpc_self.mpc_params_handles.land_speed = 0;
mpc_self.mpc_params_handles.man_pitch_max = 0;
mpc_self.mpc_params_handles.man_roll_max = 0;
mpc_self.mpc_params_handles.man_yaw_max = 0;
mpc_self.mpc_params_handles.mc_att_yaw_p = 0;
mpc_self.mpc_params_handles.opt_recover = 0;
mpc_self.mpc_params_handles.thr_hover = 0;
mpc_self.mpc_params_handles.thr_max = 0;
mpc_self.mpc_params_handles.thr_min = 0;
mpc_self.mpc_params_handles.tilt_max_air = 0;
mpc_self.mpc_params_handles.tilt_max_land = 0;
mpc_self.mpc_params_handles.tko_speed = 0;
mpc_self.mpc_params_handles.xy_ff = 0;
mpc_self.mpc_params_handles.xy_p = 0;
mpc_self.mpc_params_handles.xy_vel_cruise = 0;
mpc_self.mpc_params_handles.xy_vel_d = 0;
mpc_self.mpc_params_handles.xy_vel_i = 0;
mpc_self.mpc_params_handles.xy_vel_max = 0;
mpc_self.mpc_params_handles.xy_vel_p = 0;
mpc_self.mpc_params_handles.z_ff = 0;
mpc_self.mpc_params_handles.z_p = 0;
mpc_self.mpc_params_handles.z_vel_d = 0;
mpc_self.mpc_params_handles.z_vel_i = 0;
mpc_self.mpc_params_handles.z_vel_max_down = 0;
mpc_self.mpc_params_handles.z_vel_max_up = 0;
mpc_self.mpc_params_handles.z_vel_p = 0;
mpc_self.mpc_params_sub = 0;
mpc_self.mpc_pos = zeros(3,1);
mpc_self.mpc_pos_hold_engaged = 0;
mpc_self.mpc_pos_sp = zeros(3,1);
mpc_self.mpc_pos_sp_triplet.mpc_current.a_x = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.a_y = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.a_z = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.acceleration_valid = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.acceptance_radius = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.alt = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.alt_valid = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.cruising_speed = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.disable_mc_yaw_control = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.lat = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.lon = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.position_valid = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.type = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.valid = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.velocity_frame = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.velocity_valid = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.vx = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.vy = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.vz = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.x = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.y = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.yaw = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.yaw_valid = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.yawspeed = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.yawspeed_valid = 0;
mpc_self.mpc_pos_sp_triplet.mpc_current.z = 0;
mpc_self.mpc_pos_sp_triplet.mpc_next.alt = 0;
mpc_self.mpc_pos_sp_triplet.mpc_next.lat = 0;
mpc_self.mpc_pos_sp_triplet.mpc_next.lon = 0;
mpc_self.mpc_pos_sp_triplet.mpc_next.valid = 0;
mpc_self.mpc_pos_sp_triplet.mpc_previous.alt = 0;
mpc_self.mpc_pos_sp_triplet.mpc_previous.lat = 0;
mpc_self.mpc_pos_sp_triplet.mpc_previous.lon = 0;
mpc_self.mpc_pos_sp_triplet.mpc_previous.valid = 0;
mpc_self.mpc_pos_sp_triplet_sub = 0;
mpc_self.mpc_position_setpoint_s.SETPOINT_TYPE_FOLLOW_TARGET = 0;
mpc_self.mpc_position_setpoint_s.SETPOINT_TYPE_IDLE = 0;
mpc_self.mpc_position_setpoint_s.SETPOINT_TYPE_LAND = 0;
mpc_self.mpc_position_setpoint_s.SETPOINT_TYPE_LOITER = 0;
mpc_self.mpc_position_setpoint_s.SETPOINT_TYPE_POSITION = 0;
mpc_self.mpc_position_setpoint_s.SETPOINT_TYPE_TAKEOFF = 0;
mpc_self.mpc_position_setpoint_s.VELOCITY_FRAME_BODY_NED = 0;
mpc_self.mpc_position_setpoint_s.VELOCITY_FRAME_LOCAL_NED = 0;
mpc_self.mpc_ref_alt = 0;
mpc_self.mpc_ref_pos.cos_lat = 0;
mpc_self.mpc_ref_pos.init_done = 0;
mpc_self.mpc_ref_pos.lat_rad = 0;
mpc_self.mpc_ref_pos.lon_rad = 0;
mpc_self.mpc_ref_pos.sin_lat = 0;
mpc_self.mpc_ref_pos.timestamp = 0;
mpc_self.mpc_ref_timestamp = 0;
mpc_self.mpc_reset_alt_sp = 0;
mpc_self.mpc_reset_int_xy = 0;
mpc_self.mpc_reset_int_z = 0;
mpc_self.mpc_reset_int_z_manual = 0;
mpc_self.mpc_reset_pos_sp = 0;
mpc_self.mpc_reset_yaw_sp = 0;
mpc_self.mpc_run_alt_control = 0;
mpc_self.mpc_run_pos_control = 0;
mpc_self.mpc_t = 0;
mpc_self.mpc_t_prev = 0;
mpc_self.mpc_takeoff_jumped = 0;
mpc_self.mpc_takeoff_thrust_sp = 0;
mpc_self.mpc_thrust_int = zeros(3,1);
mpc_self.mpc_vehicle_land_detected.landed = 0;
mpc_self.mpc_vehicle_land_detected_sub = 0;
mpc_self.mpc_vehicle_status.is_rotary_wing = 0;
mpc_self.mpc_vehicle_status.is_vtol = 0;
mpc_self.mpc_vehicle_status_sub = 0;
mpc_self.mpc_vel = zeros(3,1);
mpc_self.mpc_vel_err_d = zeros(3,1);
mpc_self.mpc_vel_ff = zeros(3,1);
mpc_self.mpc_vel_prev = zeros(3,1);
mpc_self.mpc_vel_sp = zeros(3,1);
mpc_self.mpc_vel_sp_prev = zeros(3,1);
mpc_self.mpc_vel_x_deriv.dt = 0;
mpc_self.mpc_vel_x_deriv.initialized = 0;
mpc_self.mpc_vel_x_deriv.mpc_lp_block.dt = 0;
mpc_self.mpc_vel_x_deriv.mpc_lp_block.fcut = 0;
mpc_self.mpc_vel_x_deriv.mpc_lp_block.state = 0;
mpc_self.mpc_vel_x_deriv.u = 0;
mpc_self.mpc_vel_y_deriv.dt = 0;
mpc_self.mpc_vel_y_deriv.initialized = 0;
mpc_self.mpc_vel_y_deriv.mpc_lp_block.dt = 0;
mpc_self.mpc_vel_y_deriv.mpc_lp_block.fcut = 0;
mpc_self.mpc_vel_y_deriv.mpc_lp_block.state = 0;
mpc_self.mpc_vel_y_deriv.u = 0;
mpc_self.mpc_vel_z_deriv.dt = 0;
mpc_self.mpc_vel_z_deriv.initialized = 0;
mpc_self.mpc_vel_z_deriv.mpc_lp_block.dt = 0;
mpc_self.mpc_vel_z_deriv.mpc_lp_block.fcut = 0;
mpc_self.mpc_vel_z_deriv.mpc_lp_block.state = 0;
mpc_self.mpc_vel_z_deriv.u = 0;
mpc_self.mpc_vel_z_lp = 0;
mpc_self.mpc_vxy_reset_counter = 0;
mpc_self.mpc_vz_reset_counter = 0;
mpc_self.mpc_was_armed = 0;
mpc_self.mpc_xy_reset_counter = 0;
mpc_self.mpc_yaw = 0;
mpc_self.mpc_z_reset_counter = 0;

project = simulinkproject;
projectRoot = project.RootFolder;
delete(fullfile(projectRoot, 'scripts', 'mpc_self.m'));

busInfo = Simulink.Bus.createObject(mpc_self,'mpc_self','object');
movefile( fullfile(pwd, 'mpc_self.m'), fullfile(projectRoot, 'scripts', 'mpc_self.m'))

textToAppend = sprintf( ['mpc_self = Simulink.Bus;\n' ...
'mpc_self.HeaderFile = '''';\n' ...
'mpc_self.Description = ''Bus for PX4 position controller'';\n' ...
'mpc_self.DataScope = ''Auto'';\n' ...
'mpc_self.Alignment = -1;\n' ...
'mpc_self.Elements = elems;\n' ...
'clear elems;\n' ...
'assignin(''base'',''mpc_self'', mpc_self);\n']);

fcontent = fileread(fullfile(projectRoot, 'scripts', 'mpc_self.m'));
fid = fopen(fullfile(projectRoot, 'scripts', 'mpc_self.m'), 'wt');
fwrite(fid, regexp(fcontent, '(.*?)(?=slBus3 = Simulink.Bus;.*)', 'match', 'once'));
fwrite(fid, textToAppend);
fclose(fid);